name: Self-Hosted Runner Tests

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test-with-local-ollama:
    timeout-minutes: 30
    runs-on: self-hosted  # UÅ¼ywa twojego lokalnego runnera
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check Ollama status
        run: |
          curl http://localhost:11434/api/tags
          ollama list

      - name: Run all tests
        run: npm test
        continue-on-error: true
        env:
          CI: true
          GITHUB_ACTIONS: true

      - name: Generate test summary
        if: always()
        shell: pwsh
        run: |
          "## ðŸŽ­ Playwright Test Results" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          
          if (Test-Path playwright-report/results.json) {
            $results = Get-Content playwright-report/results.json | ConvertFrom-Json
            $total = 0
            $passed = 0
            $failed = 0
            $skipped = 0
            $browser = ""
            $baseURL = "N/A"
            $failedTests = @()
            
            # Parse nested structure: suites -> suites -> specs -> tests
            foreach ($suite in $results.suites) {
              if ($suite.suites) {
                foreach ($nestedSuite in $suite.suites) {
                  foreach ($spec in $nestedSuite.specs) {
                    $total += $spec.tests.Count
                    foreach ($test in $spec.tests) {
                      if ($test.status -eq "expected") { $passed++ }
                      elseif ($test.status -eq "unexpected") { 
                        $failed++
                        # Collect failed test details
                        $failedTests += @{
                          title = $spec.title
                          file = $spec.file
                          line = $spec.line
                          projectName = $test.projectName
                        }
                      }
                      elseif ($test.status -eq "skipped") { $skipped++ }
                      
                      # Get browser from first test
                      if (-not $browser -and $test.projectName) {
                        $browser = $test.projectName
                      }
                    }
                  }
                }
              }
            }
            
            # Get base URL from config (fixed path)
            if ($results.config.projects -and $results.config.projects.Count -gt 0) {
              $project = $results.config.projects[0]
              if ($project.PSObject.Properties['use'] -and $project.use.PSObject.Properties['baseURL']) {
                $baseURL = $project.use.baseURL
              }
            }
            
            "### ðŸ“Š Test Summary" >> $env:GITHUB_STEP_SUMMARY
            "- âœ… **Passed:** $passed" >> $env:GITHUB_STEP_SUMMARY
            "- âŒ **Failed:** $failed" >> $env:GITHUB_STEP_SUMMARY
            "- â­ï¸ **Skipped:** $skipped" >> $env:GITHUB_STEP_SUMMARY
            "- ðŸ“ **Total:** $total" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            
            "### ðŸŒ Test Environment" >> $env:GITHUB_STEP_SUMMARY
            if ($browser) {
              "- ðŸŒ **Browser:** $browser" >> $env:GITHUB_STEP_SUMMARY
            }
            "- ðŸ”— **Base URL:** $baseURL" >> $env:GITHUB_STEP_SUMMARY
            "- ðŸ¤– **AI Model:** llama3.2-vision:latest" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            
            "### ðŸ“„ Reports" >> $env:GITHUB_STEP_SUMMARY
            "- ðŸ“Š [View HTML Report on GitHub Pages](https://leonardust.github.io/playwright-agents/self-hosted/) (available after deployment)" >> $env:GITHUB_STEP_SUMMARY
            
            # Generate single custom annotation with test details
            if ($failed -gt 0) {
              $failedDetails = $failedTests | ForEach-Object {
                "[$($_.projectName)] â€º $($_.file):$($_.line) â€º $($_.title)"
              }
              $summary = "$failed failed " + ($failedDetails -join ", ")
              Write-Host "::notice title=ðŸŽ­ Playwright Run Summary::$summary"
            } else {
              Write-Host "::notice title=ðŸŽ­ Playwright Run Summary::$passed passed ($total total)"
            }
          } else {
            "âš ï¸ No test results found" >> $env:GITHUB_STEP_SUMMARY
            Write-Host "::warning title=ðŸŽ­ Playwright Run Summary::No test results found"
          }

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-selfhosted
          path: playwright-report/
          retention-days: 30

      - name: Upload AI logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-logs-selfhosted
          path: logs/
          retention-days: 30
